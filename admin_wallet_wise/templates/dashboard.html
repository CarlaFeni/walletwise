{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5 fade-up">
    <div class="dashboard-header fade-up" style="animation-delay: 0.3s;">
        <h1>Resumen Financiero</h1>
    </div>

    <div class="row fade-up" style="animation-delay: 0.6s;">
        <!-- Card Entradas -->
        <div class="col-md-6 mb-4">
            <div class="card h-100 clickable-card" data-card="entradas">
                <div class="card-header">Entradas</div>
                <div class="card-body text-center">
                    <div class="summary-icon">💰</div>
                    <h2 class="card-title">${{ entradas_total|floatformat:2 }}</h2>
                </div>
            </div>
        </div>

        <!-- Card Salidas -->
        <div class="col-md-6 mb-4">
            <div class="card h-100 clickable-card" data-card="salidas">
                <div class="card-header">Salidas</div>
                <div class="card-body text-center">
                    <div class="summary-icon">💸</div>
                    <h2 class="card-title">${{ salidas_total|floatformat:2 }}</h2>
                </div>
            </div>
        </div>

        <!-- Card Ahorro -->
        <div class="col-md-6 mb-4">
            <div class="card h-100 clickable-card" data-card="ahorro">
                <div class="card-header">Ahorro</div>
                <div class="card-body text-center">
                    <div class="summary-icon">🏦</div>
                    <h2 class="card-title">${{ ahorro_total|floatformat:2 }}</h2>
                </div>
            </div>
        </div>

        <!-- Card Inversiones -->
        <div class="col-md-6 mb-4">
            <div class="card h-100 clickable-card" data-card="inversiones">
                <div class="card-header">Inversiones</div>
                <div class="card-body text-center">
                    <div class="summary-icon">📈</div>
                    <h2 class="card-title">${{ inversiones_total|floatformat:2 }}</h2>
                </div>
            </div>
        </div>
    </div>
    <div class="welcome-message fade-in">
        <p class="mb-0">Tu saldo actual es de <strong>${{ saldo_total|floatformat:2 }}</strong></p>
        <button id="viewMovementsBtn" class="botonMovimientos btn">
            <i class="bi bi-list-check"></i> Ver Todos los Movimientos
        </button>
    </div>

</div>

<div id="movementsSection" class="fade-up mt-4" style="display: none; animation-delay: 0.3s;">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="mb-0 text-white">Todos los movimientos</h3>
            <div class="btn-group">
                <button class="btn btn-outline-secondary filter-btn active" data-filter="all">Todos</button>
                <button class="btn btn-outline-success filter-btn" data-filter="entradas">Entradas</button>
                <button class="btn btn-outline-danger filter-btn" data-filter="salidas">Salidas</button>
                <button class="btn btn-outline-primary filter-btn" data-filter="ahorro">Ahorro</button>
                <button class="btn btn-outline-info filter-btn" data-filter="inversiones">Inversiones</button>
            </div>
        </div>
        <div class="card-body">
            <table class="table table-striped" id="movementsTable">
                <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Nombre</th>
                    <th>Monto</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody>
                <!-- Los movimientos se cargarán dinámicamente via AJAX -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal mejorado para añadir movimientos -->
<div class="modal fade" id="movementModal" tabindex="-1" aria-labelledby="movementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title" id="movementModalLabel">Añadir movimiento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="movementForm">
                <div class="modal-body py-0">
                    <!-- Campo oculto para el tipo de movimiento -->
                    <input type="hidden" id="movementType" name="movementType">

                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="movementName" name="movementName"
                               placeholder="Nombre" required>
                        <label for="movementName">Nombre</label>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="number" step="0.01" class="form-control" id="movementAmount" name="movementAmount"
                               placeholder="Cantidad" required>
                        <label for="movementAmount">Cantidad</label>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="date" class="form-control" id="movementDate" name="movementDate" required>
                        <label for="movementDate">Fecha</label>
                    </div>
                </div>
                <div class="modal-footer flex-column border-top-0">
                    <button type="submit" class="btn-custom btn-lg w-100 mx-0 mb-2">Guardar movimiento</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3 shadow">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmLabel">Confirmar eliminación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                ¿Estás seguro de que deseas eliminar este movimiento?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<div class="footer fade-in" style="animation-delay: 1.2s;">
    <div class="container">
        <p>© 2025 Wallet Wise - Todos los derechos reservados</p>
        <p><a href="#">Política de Privacidad</a> | <a href="#">Términos de Servicio</a> | <a href="#">Soporte</a></p>
    </div>
</div>

<style>
    .modal-content {
        border: none;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .modal-header {
        background-color: #f8f9fa;
        border-top-left-radius: 1rem !important;
        border-top-right-radius: 1rem !important;
    }

    .form-floating>label {
        padding: 1rem 0.75rem;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      const movementModal = new bootstrap.Modal(document.getElementById('movementModal'));
      const modalTitle = document.getElementById('movementModalLabel');
      const movementForm = document.getElementById('movementForm');
      const movementTypeInput = document.getElementById('movementType');

      const movementsSection = document.getElementById('movementsSection');
      const viewMovementsBtn = document.getElementById('viewMovementsBtn');
      const filterBtns = document.querySelectorAll('.filter-btn');
      const movementsTableBody = document.querySelector('#movementsTable tbody');

      // Mapeo de tipos de movimiento a títulos
      const typeTitles = {
        'entradas': 'Entrada de dinero',
        'salidas': 'Salida de dinero',
        'ahorro': 'Ahorro',
        'inversiones': 'Inversión'
      };

      // Abrir modal al click en cards
      document.querySelectorAll('.clickable-card').forEach(card => {
        card.addEventListener('click', () => {
          const cardType = card.getAttribute('data-card');
          modalTitle.textContent = `Añadir ${typeTitles[cardType]}`;
          movementTypeInput.value = cardType;
          movementForm.reset();
          movementModal.show();

          // Enfocar el primer campo del formulario después de que el modal se muestre
          setTimeout(() => {
            document.getElementById('movementName').focus();
          }, 500);
        });
      });

      // Manejar submit del formulario
      movementForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Validar cantidad
        const amount = parseFloat(document.getElementById('movementAmount').value);
        if (isNaN(amount) || amount <= 0) {
          alert('Por favor ingrese una cantidad válida mayor a cero');
          return;
        }

        // Validar fecha
        const dateInput = document.getElementById('movementDate').value;
        if (!dateInput) {
          alert('Por favor seleccione una fecha');
          return;
        }

        // Preparar datos para enviar
        const formData = new FormData();
        formData.append('tipo', movementTypeInput.value);
        formData.append('nombre', document.getElementById('movementName').value);
        formData.append('monto', amount);
        formData.append('fecha', dateInput);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        try {
          // Mostrar indicador de carga
          const submitBtn = movementForm.querySelector('button[type="submit"]');
          submitBtn.disabled = true;
          submitBtn.textContent = 'Guardando...';

          // Enviar datos al servidor
          const response = await fetch('/movements/add/', {
            method: 'POST',
            body: formData
          });

          if(response.ok) {
            const result = await response.json();
            if (result.success) {
              // Actualizar los valores en las cards
              updateCardValues(result.new_values);

              // Mostrar notificación
              showNotification('¡Movimiento registrado correctamente!', 'success');

              // Cerrar modal
              movementModal.hide();
            } else {
              throw new Error(result.error || 'Error al guardar el movimiento');
            }
          } else {
            throw new Error(`Error HTTP: ${response.status}`);
          }
        } catch (error) {
          console.error('Error:', error);
          showNotification(`Error al guardar: ${error.message}`, 'error');
        } finally {
          // Restaurar botón
          const submitBtn = movementForm.querySelector('button[type="submit"]');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Guardar movimiento';
        }
      });

      // Función para formatear números con separadores de miles
      function formatNumber(number) {
        return number.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }

      // Función para actualizar los valores de las cards (ÚNICA VERSIÓN)
      function updateCardValues(newValues) {
        // Actualizar saldo total
        document.querySelector('.welcome-message strong').textContent =
            `$${formatNumber(newValues.saldo_total)}`;

        // Actualizar card de entradas
        const entradasCard = document.querySelector('[data-card="entradas"]');
        if (entradasCard) {
            entradasCard.querySelector('.card-title').textContent =
                `$${formatNumber(newValues.entradas)}`;
        }

        // Actualizar card de salidas
        const salidasCard = document.querySelector('[data-card="salidas"]');
        if (salidasCard) {
            salidasCard.querySelector('.card-title').textContent =
                `$${formatNumber(newValues.salidas)}`;
        }

        // Actualizar card de ahorro
        const ahorroCard = document.querySelector('[data-card="ahorro"]');
        if (ahorroCard) {
            ahorroCard.querySelector('.card-title').textContent =
                `$${formatNumber(newValues.ahorro)}`;
        }

        // Actualizar card de inversiones
        const inversionesCard = document.querySelector('[data-card="inversiones"]');
        if (inversionesCard) {
            inversionesCard.querySelector('.card-title').textContent =
                `$${formatNumber(newValues.inversiones)}`;
        }
      }

      // Función para mostrar notificaciones
      function showNotification(message, type) {
        // Eliminar notificación previa si existe
        const oldNotification = document.getElementById('movement-notification');
        if (oldNotification) oldNotification.remove();

        // Crear elemento de notificación
        const notification = document.createElement('div');
        notification.id = 'movement-notification';
        notification.textContent = message;
        notification.className = `notification ${type}`;

        // Añadir al documento
        document.body.appendChild(notification);

        // Mostrar y luego desaparecer después de 3 segundos
        setTimeout(() => {
          notification.style.opacity = '1';
          notification.style.transform = 'translateY(0)';
        }, 100);

        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transform = 'translateY(-100%)';
          setTimeout(() => notification.remove(), 500);
        }, 3000);
      }

      // Mostrar movimientos al hacer clic en "Ver todos los movimientos"
      viewMovementsBtn.addEventListener('click', async () => {
        movementsSection.style.display = 'block';
        await loadMovements('all');
      });

      // Manejar filtros
      filterBtns.forEach(btn => {
        btn.addEventListener('click', async () => {
          filterBtns.forEach(b => b.classList.remove('active')); // quitar activo
          btn.classList.add('active'); // marcar botón actual
          const filter = btn.getAttribute('data-filter');
          await loadMovements(filter);
        });
      });

      // Función para cargar movimientos desde el backend
      async function loadMovements(filter) {
        try {
          const response = await fetch(`/movements/get/?filter=${filter}`);
          if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
          const data = await response.json();

          // Limpiar tabla
          movementsTableBody.innerHTML = '';

          // Si no hay movimientos
          if (data.movimientos.length === 0) {
            const row = `<tr><td colspan="4" class="text-center">No hay movimientos</td></tr>`;
            movementsTableBody.insertAdjacentHTML('beforeend', row);
            return;
          }

          // Insertar filas en la tabla
          data.movimientos.forEach(mov => {
            const row = `
            <tr data-id="${mov.id}">
              <td>${new Date(mov.fecha).toLocaleDateString()}</td>
              <td>${mov.tipo}</td>
              <td>${mov.nombre}</td>
              <td>$${parseFloat(mov.monto).toFixed(2)}</td>
              <td>
                <button class="btn btn-sm btn-danger delete-movement" data-id="${mov.id}">
                  Eliminar
                </button>
              </td>
            </tr>
            `;
            movementsTableBody.insertAdjacentHTML('beforeend', row);
          });
        } catch (error) {
          console.error("Error cargando movimientos:", error);
          movementsTableBody.innerHTML =
            `<tr><td colspan="4" class="text-center text-danger">Error al cargar</td></tr>`;
        }
      }

      let movementToDelete = null; // Guardamos el ID temporalmente

      movementsTableBody.addEventListener('click', (e) => {
        if (e.target.closest('.delete-movement')) {
          const button = e.target.closest('.delete-movement');
          movementToDelete = button.getAttribute('data-id'); // guardamos el id

          // Mostrar modal
          const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
          deleteModal.show();
        }
      });

      // Cuando el usuario confirme en el modal
      document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
        if (!movementToDelete) return;

        try {
          const response = await fetch(`/movements/delete/${movementToDelete}/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'
            }
          });

          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              // Quitar fila de la tabla
              document.querySelector(`tr[data-id="${movementToDelete}"]`).remove();

              // Actualizar cards
              updateCardValues(result.new_values);

              showNotification("Movimiento eliminado con éxito", "success");
            } else {
              throw new Error(result.error || "Error al eliminar");
            }
          } else {
            throw new Error(`Error HTTP: ${response.status}`);
          }
        } catch (error) {
          console.error("Error eliminando movimiento:", error);
          showNotification(`Error al eliminar: ${error.message}`, "error");
        }

        // Cerrar modal y resetear
        const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
        deleteModal.hide();
        movementToDelete = null;
      });

    });
</script>

{% endblock %}